# LAB配方变化可视化宏说明

## 概述

本文档说明如何在Excel中集成和使用LAB配方变化可视化功能。该功能可以生成3×3共9个图表，显示LAB值与配方变量之间的关系。

## 文件说明

- `LAB_Plotting_Macro.vba` - 主要的VBA宏代码文件，包含所有绘图功能

## 安装步骤

### 1. 导入VBA代码
1. 打开包含算方功能的Excel文件
2. 按 `Alt + F11` 打开VBA编辑器
3. 在项目资源管理器中右键点击工作簿名称
4. 选择"插入" → "模块"
5. 将 `LAB_Plotting_Macro.vba` 文件的内容复制粘贴到新模块中
6. 保存工作簿（建议保存为 `.xlsm` 格式以保留宏功能）

### 2. 工作表要求
确保Excel文件包含以下工作表：

#### 宏按钮工作表
- **G14-I14**: 最优配方值 (X1, X2, X3)
- **D17-F17**: 目标LAB值 (L, A, B)
- **A19-C19**: ΔLAB值 (ΔL, ΔA, ΔB)

#### 范围工作表
- **A1列开始**: 多项式拟合系数
  - 2阶多项式：30个系数 (每个LAB分量10个)
  - 3阶多项式：60个系数 (每个LAB分量20个)
- 该工作表还将用于显示生成的图表

## 功能特性

### 图表生成
- **数量**: 3×3 = 9个图表
- **内容**: L/A/B值 vs X1/X2/X3变量的关系
- **布局**: 在范围工作表中以网格形式排列

### 双曲线显示
每个图表包含两条曲线：
- **蓝色实线**: 原始拟合多项式曲线
- **红色虚线**: 目标偏移曲线（目标LAB值 + ΔLAB值）
- **绿色圆点**: 标记最优配方点

### 多项式支持
- **2阶多项式**: 10个系数 (a₀ + a₁x₁ + a₂x₂ + a₃x₃ + a₄x₁² + a₅x₂² + a₆x₃² + a₇x₁x₂ + a₈x₁x₃ + a₉x₂x₃)
- **3阶多项式**: 20个系数 (包含所有2阶项 + 3阶交叉项)

## 使用方法

### 方法1: 手动调用
1. 完成算方过程后
2. 按 `Alt + F11` 打开VBA编辑器
3. 按 `Ctrl + G` 打开立即窗口
4. 输入 `CreateLABFormulationPlots` 并按回车

### 方法2: 按钮调用
1. 在工作表中插入一个按钮控件
2. 将按钮的宏指定为 `CreateLABFormulationPlots`
3. 点击按钮执行

### 方法3: 集成到现有流程
在现有的算方宏代码末尾添加以下代码：
```vba
' 在算方成功完成后调用绘图功能
Call IntegrateWithExistingWorkflow
```

## 配置参数

可以在VBA代码中调整以下参数：

```vba
' 图表尺寸
Const CHART_WIDTH As Double = 300    ' 图表宽度
Const CHART_HEIGHT As Double = 200   ' 图表高度

' 数据点数量
Const DATA_POINTS As Integer = 100   ' 曲线平滑度

' 变化范围
Const VARIATION_PERCENT As Double = 0.2  ' 围绕最优点的变化范围（±20%）
```

## 错误处理

### 常见错误及解决方案

1. **"工作表结构不符合要求"**
   - 确保存在"宏按钮"和"范围"工作表
   - 检查工作表名称是否正确（区分大小写）

2. **"最优配方值为空或零"**
   - 先运行算方过程获得最优解
   - 检查G14-I14单元格是否包含有效数值

3. **"无法确定多项式阶数"**
   - 检查范围工作表中的系数数量
   - 确保系数按正确格式存储

4. **"读取拟合参数失败"**
   - 验证范围工作表中系数的位置和格式
   - 根据实际数据结构调整 `ReadFittingParameters` 函数

## 自定义修改

### 调整系数读取位置
如果系数存储在不同位置，修改 `ReadFittingParameters` 函数：
```vba
Set coeffRange = ws.Range("A1:A60") ' 修改为实际范围
```

### 调整图表位置
修改 `CreateLABFormulationPlots` 函数中的起始位置：
```vba
startRow = 25 ' 起始行
startCol = 2  ' 起始列
```

### 集成现有函数
如果已有 `计算拟合值_Generic` 函数，请替换模板实现：
```vba
' 替换计算拟合值_Generic函数中的占位符代码
result = YourExisting计算拟合值_Generic(labComponent, formulation, polynomialOrder, coefficients)
```

## 性能优化建议

1. **批量操作**: 如需要多次调用，考虑关闭屏幕更新
   ```vba
   Application.ScreenUpdating = False
   ' 执行绘图操作
   Application.ScreenUpdating = True
   ```

2. **内存管理**: 大量数据时可减少 `DATA_POINTS` 常量值

3. **图表清理**: 定期清理旧图表以避免文件过大

## 技术支持

如果在使用过程中遇到问题：
1. 检查Excel宏安全设置是否允许运行VBA代码
2. 验证所有必需的数据是否正确填充
3. 根据实际数据结构调整代码中的单元格引用

## 版本历史

- **v1.0**: 初始版本，支持基本的3×3图表生成功能
- 支持2阶和3阶多项式拟合
- 双曲线显示（原始和目标偏移）
- 最优点标记功能